# 캐시

## 1차 캐시
1차 캐시는 영속성 컨텍스트 내부에 위치한다.   
따라서 엔티티 매니저로 조회하거나 변경을 수행하면 그 엔티티는 1차 캐시에 기록된다.   
그리고 트랜잭션을 커밋하거나 플러시를 호출하면 1차 케시의 변경 내용을 DB 와 동기화한다.   

JPA를 스프링 프레임워크 같은 컨테이너 위에서 실행하면    
트랜잭션을 시작할 때 영속성 컨텍스트를 생성하고, 종료할 때 컨텍스트도 종료한다.
1차 캐시는 켜고 끌 수 없으며 컨텍스트 자제가 캐시로 동작한다.   

## 2차 캐시
JPA에서 애플리케이션 전체에서 공유하는 캐시를 공유 캐시라고 하며 2차 캐시라고도 부른다.   
따라서 애플리케이션을 종료할 때까지 캐시가 유지된다.   

2차 캐시를 적용하게 되면 엔티티 매니저를 통해 데이터를 조회할 때 우선 2차 캐시를 조회하고, 그래도 없으면 데이터베이스에서 찾는다.  
이를 통해 DB 조회 횟수를 획기적으로 줄일 수 있다.   

1. 영속성 컨텍스트는 엔티티가 필요하면 2차 캐시를 조회한다.
2. 2차 캐시에 엔티티가 ㅇ벗으면 DB를 조회해서 2차 캐시에 보관한다.   
3. 2차 캐시는 자신이 보관하고 있는 엔티티를 복사해서 반환한다.   
4. 2차 캐시에 저장되어 있는 엔티티를 조회하면 복사본을 만들어서 반환한다.   

> 2차 캐시는 동시성을 극대화하기 위해 객체의 참조가 아니라 복사본을 반환한다.   
> 참조를 반환하면 동시성 문제가 발생할 수 있따.   
> 이 문제를 해결하려면 락을 사용해야 하지만, 락은 복사에 비하여 코스트가 높다.   
> 따라서 복사본을 반환한다.   

2차 캐시는 데이터베이스 기본 키를 기준으로 캐시하지만, 영속성 컨텍스트가 다르면 객체 동일성(참조 동일성) 을 보장하지 않는다.   

### 2차 캐시 기능