# 1. 트랜잭션

## 격리 수준

트랜잭션은 ACID를 보장해야 한다.  

* 원자성(Atomicity) : 트랜잭션 내에서 실행한 작업들은 하나의 작업인 것처럼 모두 성공하던가 실패해야 한다.    
* 일관성(Consistency) : 모든 트랜잭션은 일관성 있는 데이터베이스 상태를 유지해야 한다. 데이터베이스에서 정한 무결성 제약 조건을 항상 만족해야 한다.    
* 지속성(Durability) : 트랜잭션을 성공적으로 끝내면 그 결과가 항상 기록되어야 한다. 중간에 오류가 발생해도 로그 등을 사용해서 내용을 복구해야 한다.   

* 격리성 : 동시에 실행되는 트랜잭션은 서로에게 형향을 미치지 않도록 격리한다. 동시에 같은 데이터를 수정하지 못하도록해야한다.     
격리성은 동시성과 관련된 성능 이슈로 인해 여러가지 격리 수준을 선택할 수 있다.    

기본적으로 ACD 는 트랜잭션을 사용한다고 하면 별도의 설정없이 보장된다.  
반면 I(isolation : 격리성) 의 경우 동시성을 보장하기 위해 여러 수준에 따라 트레이드 오프가 있다.

트랜잭션 간에 격리성을 완벽히 보장하려면 트랜잭션을 거의 차례대로 실행해야 한다.   
하지만 이러한 경우 동시성의 처리 성능이 매우 나빠진다.    
이런 문제로 인해 ANSI 표준에서는 트랜잭션의 격리 수준을 4가지로 정의한다.   

1. READ UNCOMMITED : 커밋되지 않은 읽기
2. READ COMMITED : 커밋된 읽기
3. REPEATABLE READ : 반복 가능한 읽기
4. SERIALIZABLE : 직렬화 기능

격리 수준이 낮을수록 동시성이 증가하지만, 격리 수준에 따라 다양한 문제가 발생한다.  

## 격리 수준

격리 수준 | dirty read | non-repeatable-read | phantom read
:--- | :---: | :---:| :---: |
READ UNCOMMITED | o | o | o
READ COMMITED |  | o | o
REPEATABLE READ |  |  | o
SERIALIZABLE |  |  | 

격리 수준이 증가함에 따라 문제점이 사라진다.   

> 대부분의 DATABASE는 기본 설정으로 Read Committed 격리 수준을 사용한다.

### 1. READ UNCOMMITED : 보장하지 않음

커밋하지 않은 데이터를 읽을 수 있다.    
예를 들어 트랜잭션A가 특정 row를 수정하고 있는대 이를 커밋하기 이전이라도    
트랜잭션 B가 해당 row에 접근하여 조회할 수 있다.      
이것을 DIRTY READ라 한다.   
트랜잭션B가 DIRTY READ한 데이터를 사용하는데 트랜잭션 A를 롤백한다면 데이터 정합성에 심각한 문제가 발생한다.   
DIRTY READ를 허용하는 격리 수준을 READ UNCOMMITED라 한다.   

### 2. READ COMMITED : commit된 데이터만 읽는 것을 보장

트랜잭션은 커밋한 데이터만 읽을 수 있다.    
따라서 커밋되지 않은 데이터를 읽을 수 있는 문제인 Dirty Read를 방지할 수 있다.    
하지만 여전히 문제점이 있으며 이는 non-repeatablep-read 문제이다.    
예를 들어 트랜잭션A가 회원 1을 조회 중인데 갑자기 트랜잭션B가 회원 1을 수정하고 커밋하면    
트랜잭션A가 다시 회원 1을 조회하면 수정된 데이터가 조회된다.(커밋된 데이터를 읽었으므로 Dirty Read는 발생하지 않았다.)    

이처럼 반복해서 같은 데이터를 읽을 수 없는 상태를 Non-Repeatable-read라고 한다.   
Dirty-Read는 허용하지 않지만, Non-Repeatable-Read는 허용하는 격리 수준을 READ COMMITED 라고 한다.   

### 3. REPEATABLE READ : 같은 row를 반복해서 읽었을 때 동일함을 보장

한 번 조회한 데이터를 반복해서 조회해도 같은 데이터가 조회된다.   
하지만 PHANTOM READ는 발생할 수 있따.   
트랜잭션A가 10살 이하의 회원을 조회했는대 트랜잭션B가 5살 회원을 추가하고 커밋한다면    
트랜잭션A가 다시 같은 조건으로 조회를 시도하면 새롭게 회원 하나가 추가된 리스트를 조회하게 된다.   
이렇게 반복 조회 시 결과 집합이 달라지는 것을 Phantom Read라고 한다.    
Non-Repeatable-Read는 허용하지 않지만, Phantom Read는 허용하는 격리 수준을 REPEATABLE READ라고 한다.   

### 4. SERIALIZABLE : 어떤 쿼리더라도 동일함을 보장

가장 엄격한 수준의 트랜잭션으로 PHANTOM READ가 발생하지 않는다.    
하지만 동시성 처리 성능이 급격하게 떨어진다.   


애플리케이션 대부분은 동시성 처리가 중요하므로 데이베이스들은 보통 READ COMMITED 격리 수준을 기본으로 사용한ㄷ가.   
일부 중요한 비즈니스 로직에 더 높은 격리 수준이 필요하면    
데이터베이스 트랜잭션이 제공하는 잠금 기능을 활용하면 된다.   

> 트랜잭션 격리 수준에 따른 통작 방식은 데이터베이스마다 다르다.    
> 최근에는 동시성 처리를 위해 락보다는 MVCC를 사용하므로 락을 사용하는 DB와는 약간 다르다.

